#!/bin/bash
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -ex

export BOOST_ROOT=${BOOST_ROOT:-/opt/toolchain/boost-pic-1.55.0}
LLVM_PATH=${LLVM_PATH:-/opt/toolchain/llvm-3.3}

if [ -z "$GIT_REPO" ]; then

    export NO_REBUILD_THIRDPARTY=true
    export CC=${LLVM_PATH}/bin/clang CXX=${LLVM_PATH}/bin/clang++
    ./thirdparty/download-thirdparty.sh
    ./thirdparty/build-thirdparty.sh
    unset CC CXX

    CMAKE='thirdparty/installed/bin/cmake -DKUDU_LINK=static'
    MAKE='make -j8'
    for type in release fastdebug; do
        ${CMAKE} -DCMAKE_BUILD_TYPE=${type}
        ${MAKE}
    done

    ${CMAKE} -DCMAKE_BUILD_TYPE=debug -DKUDU_EXPORTED_CLIENT=1
    ${MAKE} install DESTDIR=`pwd`/client
else
    rm -rf build kudu-${FULL_VERSION}
    ALL_FILES=`echo *`
    mkdir build kudu-${FULL_VERSION}
    cp -r $ALL_FILES kudu-${FULL_VERSION}
    tar czf build/kudu-${FULL_VERSION}.tar.gz kudu-${FULL_VERSION}
fi

